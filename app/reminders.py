from __future__ import annotations

import random
from typing import Sequence

import aiosqlite
from aiogram import Bot
from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup

from .repo import (
    advance_reminder_stage,
    get_due_reminders,
    stop_reminders,
)
from .timeutil import now_ts


REMINDER_MESSAGES: Sequence[str] = (
    "–¢–≤–æ–π –ø–æ–¥–∞—Ä–æ–∫ –≤—Å—ë –µ—â—ë –∂–¥—ë—Ç —Ç–µ–±—è üéÅ",
    "–ö–∞–∂–µ—Ç—Å—è, —Ç—ã –∑–∞–±—ã–ª –ø—Ä–æ —Å–≤–æ–π –ø–æ–¥–∞—Ä–æ–∫‚Ä¶ –ó–∞–±–µ—Ä–∏ –µ–≥–æ —Å–∫–æ—Ä–µ–µ! üéÅ",
    "–ü–æ–¥–∞—Ä–æ–∫ —É–∂–µ –∑–∞–∂–¥–∞–ª—Å—è, –∑–∞–≥–ª—è–Ω–∏ –≤ –±–æ—Ç–∞ üòâ",
    "–ï—â—ë –Ω–µ –≤—ã–±—Ä–∞–ª –ø–æ–¥–∞—Ä–æ–∫? –°–∞–º–æ–µ –≤—Ä–µ–º—è —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å üéÅ",
    "–ù–µ —É–ø—É—Å—Ç–∏ —Å–≤–æ–π —à–∞–Ω—Å –Ω–∞ –ø–æ–¥–∞—Ä–æ–∫ ‚Äî –æ–Ω –≤—Å—ë –µ—â—ë —Ç—É—Ç ‚ú®",
    "–ú—ã –≤—Å—ë –µ—â—ë –¥–µ—Ä–∂–∏–º –¥–ª—è —Ç–µ–±—è –ø–æ–¥–∞—Ä–æ–∫ üéÅ –ó–∞–±–µ—Ä–∏ –µ–≥–æ —Å–∫–æ—Ä–µ–µ!",
    "–ù–∞–ø–æ–º–∏–Ω–∞–µ–º –ø—Ä–æ –ø–æ–¥–∞—Ä–æ–∫ ‚Äî –æ–Ω –ø–æ–∫–∞ –¥–æ—Å—Ç—É–ø–µ–Ω ‚ú® –ú–æ–∂–µ—Ç –∑–∞–±–µ—Ä–µ—à—å –µ–≥–æ —Å–µ–π—á–∞—Å?",
    "–¢–≤–æ–π –ø–æ–¥–∞—Ä–æ–∫ –≤—Å—ë –µ—â—ë –º–æ–∂–Ω–æ –∑–∞–±—Ä–∞—Ç—å üéÅ –ù–µ —É–ø—É—Å—Ç–∏ —à–∞–Ω—Å!",
    "–ü–æ–¥–∞—Ä–æ–∫ –∂–¥—ë—Ç —Ç–µ–±—è, –Ω–æ –Ω–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ üòâ –°–∫–æ—Ä–æ –∫—Ç–æ-—Ç–æ –µ–≥–æ –∑–∞–±–µ—Ä—ë—Ç!",
    "–ú—ã —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ —Ç–≤–æ–π –ø–æ–¥–∞—Ä–æ–∫ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –≤–µ—Ä–Ω—ë—à—å—Å—è üéÅ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–±–µ—Ä–∏ –µ–≥–æ!",
    "–ü–æ–¥–∞—Ä–æ–∫ –≤—Å—ë –µ—â—ë –∑–¥–µ—Å—å ‚Äî —Ä–µ—à–∏–ª–∏ –Ω–∞–ø–æ–º–Ω–∏—Ç—å üôÇ –ï—Å–ª–∏ –Ω–µ –∑–∞–±–µ—Ä–µ—à—å, –æ–Ω —Å–≥–æ—Ä–∏—Ç!",
    "–¢—ã –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª –≤—ã–±–æ—Ä –ø–æ–¥–∞—Ä–∫–∞ üéÅ –ó–∞–≥–ª—è–Ω–∏ –≤ –±–æ—Ç–∞ –∏ –≤—ã–±–µ—Ä–∏ –µ–≥–æ!",
    "–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: –ø–æ–¥–∞—Ä–æ–∫ –ø–æ–∫–∞ –Ω–∏–∫—É–¥–∞ –Ω–µ –¥–µ–ª—Å—è. –ó–∞–±–µ—Ä–∏ –µ–≥–æ —Å–∫–æ—Ä–µ–µ!",
    "–ü–æ–¥–∞—Ä–æ–∫ –≤—Å—ë –µ—â—ë –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Ç–µ–±—è üéÅ –ù–µ —É–ø—É—Å—Ç–∏ —à–∞–Ω—Å!",
    "–†–µ—à–∏–ª–∏ –Ω–∞–ø–æ–º–Ω–∏—Ç—å –ø—Ä–æ —Ç–≤–æ–π –ø–æ–¥–∞—Ä–æ–∫ üòâ –ó–∞–±–µ—Ä–∏ –µ–≥–æ —Å–∫–æ—Ä–µ–µ!",
    "–¢—ã –±—ã–ª –±–ª–∏–∑–∫–æ ‚Äî –ø–æ–¥–∞—Ä–æ–∫ –≤—Å—ë –µ—â—ë –∂–¥—ë—Ç ‚ú® –ó–∞–≥–ª—è–Ω–∏ –≤ –±–æ—Ç–∞ –∏ –∑–∞–±–µ—Ä–∏ –µ–≥–æ!",
    "–ú—ã –Ω–µ —É–±—Ä–∞–ª–∏ —Ç–≤–æ–π –ø–æ–¥–∞—Ä–æ–∫‚Ä¶ –ø–æ–∫–∞ üéÅ –ó–∞–±–µ—Ä–∏ –µ–≥–æ —Å–∫–æ—Ä–µ–µ!",
    "–ï—Å–ª–∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ ‚Äî –ø–æ–¥–∞—Ä–æ–∫ –≤—Å—ë –µ—â—ë —Ç—É—Ç üôÇ –ó–∞–±–µ—Ä–∏ –µ–≥–æ —Å–∫–æ—Ä–µ–µ!",
    "–ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –Ω–∞–ø–æ–º–∏–Ω–∞–µ–º –ø—Ä–æ –ø–æ–¥–∞—Ä–æ–∫ üéÅ –ó–∞–±–µ—Ä–∏ –µ–≥–æ —Å–∫–æ—Ä–µ–µ!",
)


def _build_reminder_markup() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="üéÅ –ó–∞–±–µ—Ä–∏ —Å–≤–æ–π –ø–æ–¥–∞—Ä–æ–∫", callback_data="menu:home"
                )
            ]
        ]
    )


async def process_due_reminders(bot: Bot, conn: aiosqlite.Connection) -> None:
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, —É –∫–æ—Ç–æ—Ä—ã—Ö –Ω–∞—Å—Ç—É–ø–∏–ª–æ –≤—Ä–µ–º—è next_reminder_ts.
    –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–±–∞–Ω–µ–Ω –∏ –µ—â—ë –Ω–µ –≤—ã–∏–≥—Ä—ã–≤–∞–ª –ø–æ–¥–∞—Ä–∫–æ–≤.
    """
    now = now_ts()
    rows = await get_due_reminders(conn, now)
    if not rows:
        return

    for r in rows:
        user_id = int(r["user_id"])
        stage = int(r["stage"])
        first_done = bool(r["first_sequence_done"])
        is_banned = int(r["is_banned"] or 0)

        if is_banned:
            # –û—Ç–∫–ª—é—á–∞–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∑–∞–±–∞–Ω–µ–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
            await stop_reminders(conn, user_id)
            continue

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–∏–≥—Ä—ã–≤–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–∞—Ä–∫–∏
        cur = await conn.execute(
            "SELECT COUNT(1) AS c FROM inventory WHERE user_id=?", (user_id,)
        )
        inv_row = await cur.fetchone()
        has_gifts = bool(inv_row and int(inv_row["c"]) > 0)
        if has_gifts:
            # –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –ø–æ–¥–∞—Ä–∫–∏, –æ—Ç–∫–ª—é—á–∞–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
            await stop_reminders(conn, user_id)
            continue

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
        text = random.choice(REMINDER_MESSAGES)
        try:
            await bot.send_message(
                chat_id=user_id,
                text=text,
                reply_markup=_build_reminder_markup(),
            )
        except Exception:
            # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ª—é–±—ã–µ –æ—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –±–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω)
            pass

        # –ü–µ—Ä–µ–≤–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é —Å—Ç–∞–¥–∏—é –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
        await advance_reminder_stage(conn, user_id, stage, first_done)


async def run_reminders_loop(bot: Bot, conn: aiosqlite.Connection) -> None:
    """
    –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞, –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—é—â–∞—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è.
    """
    import asyncio

    while True:
        try:
            await process_due_reminders(bot, conn)
        except Exception:
            # –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –º–æ–∂–Ω–æ –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏
            pass
        await asyncio.sleep(30)


